<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2015/3/9
 * Time: 11:21
 */


define("BASEPATH", dirname(__FILE__) . '/');

include_once BASEPATH . 'config/conf.php';
include_once BASEPATH . 'model/voip.php';
include_once INCLUDE_PATH . 'libraries/SmsGateway.class.php';
include_once INCLUDE_PATH . 'libraries/Redis.class.php';


$input = new CI_Input();
$mobile = trim($input->get_post('mobile'));
$imei = trim($input->get_post('imei'));

$_table = 'T_phone_info';
$_code_table = 'T_phone_verify';

if(CLIENT_PLATFORM == 'iphone' || CLIENT_PLATFORM == 'android'){
	$format = 'json';
}
else{
	$format = 'txt';
	header("Content-Type: text/html;charset=utf-8");
	header("Content-Length: 3");
}
$voip = new voip();

if($mobile && $imei){
	if($voip->get_num($_table,array('mobile'=>$mobile,'imei'=>$imei,'status'=>1))){
		//已激活
		sendput('180',$format);
	}
	else{
		//未激活，跳转至注册登陆步骤
		sendput('181',$format);
	}
}else{
	$redis = new RedisInit();
	$time = $redis->redis()->get($mobile.'C');
	$time = !empty($time) ? $time : 0;
//	if($time < 10){
		$code = $redis->redis()->hGet('VerifyCode',$mobile);
		if(!empty($code)){
			$rand_num =  $code;
		}
		else{
			$rand_num =  generate_password(4);
			$redis->redis()->hSet('VerifyCode',$mobile,$rand_num);
		}
//        $tag = strpos($mobile,'0086');
        if(strpos($mobile, '0086') !== false){
            $stype = 'hztk';
        }
        else{
            $stype = 'outk';
        }
//        $stype = !empty($tag) ? 'hztk':'outk';
		$msg = '您的啊哩咕哩的验证码是：'.$rand_num;
		$sms = new SmsGateway();
		$result = $sms->send_sms($mobile, $stype, $msg);
		if ($result) {
			if(empty($time)) {
				$voip->insert_data($_code_table,array('mobile'=>$mobile,'type'=>$format,'code'=>$rand_num,'created'=>date("Y-m-d H:i:s")));
			}
			$time = $redis->redis()->set($mobile.'C',++$time,strtotime(date("Y-m-d 23:59:59"))-time());
//			$u = $redis->redis()->get($mobile.'C');
            _logger(_LL_DEBUG,'sms_succ,type:'.$stype.',mobile:'.$mobile.',msg:'.$msg);
            sendput('181',$format);
		}else{
            _logger(_LL_DEBUG,'sms_fail,type:'.$stype.',mobile:'.$mobile.',msg:'.$msg);
            sendput('123',$format);
		}
//	}
//	else{
//		sendput('124',$format);
//	}

	}



