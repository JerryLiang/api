<?php

/*
  首次添加设备成为管理员,移交管理员，加载列表
 */

define("BASEPATH", dirname(__FILE__) . '/');
include_once BASEPATH . 'config/system.php';
include_once BASEPATH . 'config/conf.php';
include_once BASEPATH . 'config/database.php';
include_once INCLUDE_PATH . 'libraries/Auth.class.php';
include_once BASEPATH . 'model/user.php';

$input = new CI_Input();
$username = trim($input->get_post('user'));
$mobile = trim($input->get_post('mobile'));
$imei = trim($input->get_post('imei'));
//$udid = trim($input->get_post('udid'));
$pass= trim($input->get_post('pass'));
$action = trim($input->get_post('action'));


$auth = Auth::getInstance($dbconfig['mainuser']);
$reVal = array('content' => '', 'status' => 103);

$img_url_prefix = $url_prefixs[array_rand($url_prefixs)];

if (empty($username) || empty($mobile) ||empty($action)) {
	$reVal['content'] = _display_error('102');
	$reVal['status'] = 102;
} elseif (!$auth->verify()) {
	$reVal['content'] = _display_error('101');
	$reVal['status'] = 101;
} else {
	$imdata = array('master' => $mobile, 'member' => $username);
	$user = new user_model();
	switch ($action) {
		case 'list': //成员列表

			$reVal['list'] = array();
			$query = $auth->_main_user_db->query("select member from `T_group_info` WHERE `mobile`='" . $mobile . "' limit 1");
			if ($query && $query->num_rows() > 0) {
				$member = unserialize($query->row()->member);
				$i = 0;
				foreach ($member as $val) {
					$ret = array();
					$temp[$i] = $val;
					$ret = $auth->_main_user_db->query("select headimag,names from `T_user_info` WHERE `username`='" . $val['username'] . "' limit 1");
					$headimg = $ret->row()->headimag;
					$temp[$i]['headimag'] = !empty($headimg) ? $img_url_prefix . $headimg : '';
					$temp[$i]['name'] = $ret->row()->names;
					$i++;
				}
				$phone = $auth->_main_user_db->query("select headimag,names from `T_phone_info` WHERE `mobile`='" . $mobile . "' limit 1");
				$phoneimg = $phone->row()->headimag;
				$temp[$i]['username'] = $mobile;
				$temp[$i]['headimag'] = !empty($phoneimg) ? $img_url_prefix . $phoneimg : '';
				$temp[$i]['name'] = $phone->row()->names;
				$reVal['status'] = 0;
				$reVal['list'] = $temp;
			}
			unset($query);
			break;
		case 'move': //移交管理员
			$moveuser = trim($input->get_post('moveuser'));
			if (empty($moveuser)) {
				$reVal['content'] = _display_error('102');
				$reVal['status'] = 102;
			} else {
				$info = $user->check_record("select id from `T_group_info` WHERE `isadmin`='" . $username . "' and `mobile` = " . $mobile, 'val');
//				echo $info;exit;
				if ($info) {
					$auth->_main_user_db->set('isadmin', $moveuser);
					$auth->_main_user_db->where('id', $info);
					if ($auth->_main_user_db->update('T_group_info') && $auth->_main_user_db->affected_rows() > 0) {
						$reVal['content'] = _display_error('166');
						$reVal['status'] = 166;
					} else {
						$reVal['content'] = _display_error('167');
						$reVal['status'] = 167;
					}
				} else {
					$reVal['content'] = _display_error('165');
					$reVal['status'] = 165;
				}
				unset($info);
			}
			break;
		case 'adduser': //添加管理员
			$phone = $auth->_main_user_db->query("select * from `T_phone_info` WHERE `mobile` = '" . $mobile .  "'");
//			$phone = $user->check_record("select id from `T_phone_info` WHERE `imei`='" . $imei . "'");
			$par = $phone->row_array();
			if (!empty($par) && $par['imei']) {
//				号码未被关注激活
				if (!$par['status']){
					$id = $phone->row()->id;
				$info = $user->check_record("select id from `T_group_info` WHERE `mobile`='" . $mobile . "'");
				if (!$info) {
					$data = array(
						'mobile' => $mobile,
						'isadmin' => $username,
						'member' => serialize(array(array('username' => $username, 'udid' => $udid)))
					);
					//添加设备列表
					$query = $auth->_main_user_db->query("select id from `T_user_imei` WHERE `username`='" . $username . "' and `mobile`='" . $mobile . "' limit 1");
					if ($query && $query->num_rows() <= 0) {
						$user->insert_imserver($imdata);
//							$names = !empty($phone->row()->names) ? $phone->row()->names ; '';
						$auth->_main_user_db->query("insert into T_user_imei(username,udid,mobile,names,headimag)value('" . $username . "','" . $udid . "','" . $mobile . "','" . $phone->row()->names . "','" . $phone->row()->headimag . "')");
						//更新用户信息
						$auth->_main_user_db->query("update T_user_info set mobile='" . $mobile . "' where username='" . $username . "'");
						if ($auth->_main_user_db->insert('T_group_info', $data) && $auth->_main_user_db->affected_rows() > 0) {
							$reVal['status'] = 0;
							$reVal['mobile'] = $mobile;
							$reVal['content'] = _display_error('161');
						}
					}
					$auth->_main_user_db->query("update T_phone_info set status = 1 where mobile='" . $mobile . "'");
					unset($info);
				} else {
					$reVal['content'] = _display_error('162');
					$reVal['status'] = 162;
				}
				unset($query);
				unset($info);
				break;
			}
				//激活voip
//				。。。。。。。。。。。。。。。。。
			} else {
				$reVal['content'] = _display_error('179');
				$reVal['status'] = 179;
			}

	}
}
echo json_encode($reVal);
?>